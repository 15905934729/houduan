<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>线路分析</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
        }

        .container {
            background-color: #ffffff;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 22px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            font-size: 14px;
            transition: background-color 0.2s ease;
        }

        .btn-primary {
            background-color: #2288c9;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1a6fa8;
        }

        .btn-success {
            background-color: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background-color: #3d8b40;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: #364f6b;
            color: white;
            text-align: center;
            padding: 12px;
            font-weight: 500;
        }

        td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tbody tr {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        tbody tr:hover {
            background-color: #f0f8ff;
        }

        select {
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .status-available {
            color: #4caf50;
        }

        .status-unavailable {
            color: #f44336;
        }

        .delay-value,
        .bandwidth-value,
        .loss-value {
            font-weight: 500;
        }

        .delay-good {
            color: #4caf50;
        }

        .delay-medium {
            color: #ff9800;
        }

        .delay-bad {
            color: #f44336;
        }

        .bandwidth-high {
            color: #4caf50;
        }

        .bandwidth-medium {
            color: #ff9800;
        }

        .bandwidth-low {
            color: #f44336;
        }

        .loss-good {
            color: #4caf50;
        }

        .loss-bad {
            color: #f44336;
        }

        #resultDiv {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        /* 弹出窗口样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
            position: relative;
            width: 600px;
        }
        
        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            background: none;
            border: none;
            padding: 0;
        }
        
        .close-button:hover {
            color: #000;
        }
        
        .modal-title {
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            font-size: 18px;
        }
        
        /* 添加线路弹窗样式 */
        .add-line-form {
            margin-top: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            gap: 10px;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        /* 加载动画样式 */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px 0;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-left-color: #2288c9;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 16px;
            color: #555;
            font-weight: 500;
        }
        
        /* 延迟曲线图表弹窗样式 */
        .chart-modal {
            width: 900px;
        }
        
        .chart-container {
            width: 100%;
            margin-top: 15px;
            display: flex;
            gap: 15px;
            justify-content: space-between;
        }
        
        .chart-box {
            flex: 1;
            height: 280px;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 5px;
            background-color: #fff;
        }
        
        .chart-title {
            text-align: center;
            font-size: 15px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        .line-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .info-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 16px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>线路分析</h1>
            <button class="btn btn-primary" id="addLineButton">添加线路</button>
        </div>

        <div class="table-container">
            <div class="table-header">
                <div></div>
                <button class="btn btn-success" id="runWorkflowButton">AI分析</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>线路名称</th>
                        <th>延迟 (ms)</th>
                        <th>带宽 (Mbps)</th>
                        <th>丢包率 (%)</th>
                        <th>状态</th>
                    </tr>
                </thead>
                <tbody id="lineTableBody">
                    <tr data-line-id="1">
                        <td>线路1</td>
                        <td><span class="delay-value delay-good">8</span></td>
                        <td><span class="bandwidth-value bandwidth-high">1000</span></td>
                        <td><span class="loss-value loss-good">0.1</span></td>
                        <td>
                            <select class="status-select">
                                <option value="available" selected>可用</option>
                                <option value="unavailable">不可用</option>
                            </select>
                        </td>
                    </tr>
                    <tr data-line-id="2">
                        <td>线路2</td>
                        <td><span class="delay-value delay-medium">13</span></td>
                        <td><span class="bandwidth-value bandwidth-high">800</span></td>
                        <td><span class="loss-value loss-good">0.13</span></td>
                        <td>
                            <select class="status-select">
                                <option value="available" selected>可用</option>
                                <option value="unavailable">不可用</option>
                            </select>
                        </td>
                    </tr>
                    <tr data-line-id="3">
                        <td>线路3</td>
                        <td><span class="delay-value delay-good">5</span></td>
                        <td><span class="bandwidth-value bandwidth-medium">500</span></td>
                        <td><span class="loss-value loss-good">0.05</span></td>
                        <td>
                            <select class="status-select">
                                <option value="available" selected>可用</option>
                                <option value="unavailable">不可用</option>
                            </select>
                        </td>
                    </tr>
                    <tr data-line-id="4">
                        <td>线路4</td>
                        <td><span class="delay-value delay-bad">17</span></td>
                        <td><span class="bandwidth-value bandwidth-high">750</span></td>
                        <td><span class="loss-value loss-good">0.1</span></td>
                        <td>
                            <select class="status-select">
                                <option value="available">可用</option>
                                <option value="unavailable" selected>不可用</option>
                            </select>
                        </td>
                    </tr>
                    <tr data-line-id="5">
                        <td>线路5</td>
                        <td><span class="delay-value delay-medium">10</span></td>
                        <td><span class="bandwidth-value bandwidth-low">400</span></td>
                        <td><span class="loss-value loss-bad">0.26</span></td>
                        <td>
                            <select class="status-select">
                                <option value="available">可用</option>
                                <option value="unavailable" selected>不可用</option>
                            </select>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- 告警信息区域 -->
        <div class="alerts-container" style="margin-top: 40px; border-top: 3px solid #e0e0e0; padding-top: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="font-size: 20px; color: #333; margin: 0; display: flex; align-items: center;">
                    <i class="fas fa-exclamation-triangle" style="margin-right: 10px; color: #f44336;"></i>
                    系统告警中心
                </h2>
                <button class="btn btn-primary" style="background-color: #666; font-size: 13px;">清除已处理告警</button>
            </div>
            <div style="background-color: #f9f9f9; padding: 20px; border-radius: 8px; border: 1px solid #eeeeee;">
                <!-- 红色告警 - 高危 -->
                <div class="alert-card" style="background-color: #fff; border-radius: 6px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; display: flex;">
                    <div style="width: 6px; background-color: #f44336;"></div>
                    <div style="padding: 16px; flex-grow: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; font-size: 16px; font-weight: 500; color: #f44336;">设备离线</h3>
                            <span style="color: #999; font-size: 13px;">2025-05-20 14:01:00-之前</span>
                        </div>
                        <p style="margin: 8px 0 0 0; color: #666; font-size: 14px;">A5设备状态发生改变，设备下线。</p>
                    </div>
                    <div style="padding: 16px; display: flex; align-items: center;">
                        <button style="background-color: #f44336; color: white; border: none; border-radius: 4px; padding: 5px 12px; font-size: 13px; cursor: pointer;">处理</button>
                    </div>
                </div>
                
                <!-- 黄色告警 - 中危 -->
                <div class="alert-card" style="background-color: #fff; border-radius: 6px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; display: flex;">
                    <div style="width: 6px; background-color: #ff9800;"></div>
                    <div style="padding: 16px; flex-grow: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; font-size: 16px; font-weight: 500; color: #ff9800;">设备端口发生震荡</h3>
                            <span style="color: #999; font-size: 13px;">2025-05-23 14:00:28-之前</span>
                        </div>
                        <p style="margin: 8px 0 0 0; color: #666; font-size: 14px;">C1设备Eth 1端口状态发生改变，流量更改转发路径。</p>
                    </div>
                    <div style="padding: 16px; display: flex; align-items: center;">
                        <button style="background-color: #ff9800; color: white; border: none; border-radius: 4px; padding: 5px 12px; font-size: 13px; cursor: pointer;">处理</button>
                    </div>
                </div>
                
                <!-- 蓝色告警 - 低危 -->
                <div class="alert-card" style="background-color: #fff; border-radius: 6px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; display: flex;">
                    <div style="width: 6px; background-color: #2196f3;"></div>
                    <div style="padding: 16px; flex-grow: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; font-size: 16px; font-weight: 500; color: #2196f3;">带宽使用率超阈值</h3>
                            <span style="color: #999; font-size: 13px;">2025-05-28 13:45:10-之前</span>
                        </div>
                        <p style="margin: 8px 0 0 0; color: #666; font-size: 14px;">线路2带宽使用率达到85%，超过预设阈值(80%)，持续时间5分钟。</p>
                    </div>
                    <div style="padding: 16px; display: flex; align-items: center;">
                        <button style="background-color: #2196f3; color: white; border: none; border-radius: 4px; padding: 5px 12px; font-size: 13px; cursor: pointer;">处理</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="resultDiv"></div>
    </div>
    
    <!-- 弹出窗口 -->
    <div id="resultModal" class="modal">
        <div class="modal-content">
            <button class="close-button" id="closeModalButton">&times;</button>
            <h3 class="modal-title">线路分析结果</h3>
            <div id="modalResultContent">
                <!-- 加载动画将在这里显示 -->
            </div>
        </div>
    </div>
    
    <!-- 添加线路弹窗 -->
    <div id="addLineModal" class="modal">
        <div class="modal-content">
            <button class="close-button" id="closeAddLineModalButton">&times;</button>
            <h3 class="modal-title">添加新线路</h3>
            <div class="add-line-form">
                <div class="form-group">
                    <label for="lineName">线路名称</label>
                    <input type="text" id="lineName" value="" readonly>
                </div>
                <div class="form-group">
                    <label for="lineDelay">延迟 (ms)</label>
                    <input type="number" id="lineDelay" placeholder="请输入延迟值" min="0">
                </div>
                <div class="form-group">
                    <label for="lineBandwidth">带宽 (Mbps)</label>
                    <input type="number" id="lineBandwidth" placeholder="请输入带宽值" min="0">
                </div>
                <div class="form-group">
                    <label for="lineLossRate">丢包率 (%)</label>
                    <input type="number" id="lineLossRate" placeholder="请输入丢包率" min="0" step="0.01">
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" id="cancelAddLineButton">取消</button>
                    <button class="btn btn-primary" id="confirmAddLineButton">确认</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 延迟曲线图表弹窗 -->
    <div id="chartModal" class="modal">
        <div class="modal-content chart-modal">
            <button class="close-button" id="closeChartModalButton">&times;</button>
            <h3 class="modal-title" id="chartModalTitle">线路监控数据</h3>
            
            <div class="line-info">
                <div class="info-item">
                    <div class="info-label">线路名称</div>
                    <div class="info-value" id="chartLineName">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">当前延迟</div>
                    <div class="info-value" id="chartLineDelay">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">带宽</div>
                    <div class="info-value" id="chartLineBandwidth">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">丢包率</div>
                    <div class="info-value" id="chartLineLoss">-</div>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-box">
                    <div class="chart-title">延迟 (ms)</div>
                    <canvas id="delayChart"></canvas>
                </div>
                <div class="chart-box">
                    <div class="chart-title">带宽 (Mbps)</div>
                    <canvas id="bandwidthChart"></canvas>
                </div>
                <div class="chart-box">
                    <div class="chart-title">丢包率 (%)</div>
                    <canvas id="lossChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let lineCount = 5; // 当前线路数量
        let delayChart = null; // 延迟图表对象
        let bandwidthChart = null; // 带宽图表对象
        let lossChart = null; // 丢包率图表对象
        
        // 添加线路按钮事件
        document.getElementById('addLineButton').addEventListener('click', () => {
            lineCount++;
            // 设置默认线路名称
            document.getElementById('lineName').value = `线路${lineCount}`;
            
            // 清空其他输入框
            document.getElementById('lineDelay').value = '';
            document.getElementById('lineBandwidth').value = '';
            document.getElementById('lineLossRate').value = '';
            
            // 显示添加线路弹窗
            document.getElementById('addLineModal').style.display = 'flex';
        });
        
        // 关闭添加线路弹窗
        document.getElementById('closeAddLineModalButton').addEventListener('click', () => {
            document.getElementById('addLineModal').style.display = 'none';
        });
        
        // 取消添加线路
        document.getElementById('cancelAddLineButton').addEventListener('click', () => {
            document.getElementById('addLineModal').style.display = 'none';
            lineCount--; // 恢复计数器
        });
        
        // 确认添加线路
        document.getElementById('confirmAddLineButton').addEventListener('click', () => {
            // 获取用户输入的值
            const lineName = document.getElementById('lineName').value;
            const delay = document.getElementById('lineDelay').value || '10';
            const bandwidth = document.getElementById('lineBandwidth').value || '800';
            const lossRate = document.getElementById('lineLossRate').value || '0.1';
            
            // 确定延迟、带宽和丢包率的CSS类
            const delayClass = delay <= 10 ? 'delay-good' : (delay <= 15 ? 'delay-medium' : 'delay-bad');
            const bandwidthClass = bandwidth >= 800 ? 'bandwidth-high' : (bandwidth >= 500 ? 'bandwidth-medium' : 'bandwidth-low');
            const lossClass = lossRate <= 0.2 ? 'loss-good' : 'loss-bad';
            
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-line-id', lineCount);
            
            newRow.innerHTML = `
                <td>${lineName}</td>
                <td><span class="delay-value ${delayClass}">${delay}</span></td>
                <td><span class="bandwidth-value ${bandwidthClass}">${bandwidth}</span></td>
                <td><span class="loss-value ${lossClass}">${lossRate}</span></td>
                <td>
                    <select class="status-select">
                        <option value="available" selected>可用</option>
                        <option value="unavailable">不可用</option>
                    </select>
                </td>
            `;
            
            // 为新行添加点击事件
            newRow.addEventListener('click', handleRowClick);
            
            document.getElementById('lineTableBody').appendChild(newRow);
            document.getElementById('addLineModal').style.display = 'none';
        });
        
        // 点击弹窗外部关闭添加线路弹窗
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('addLineModal');
            if (event.target === modal) {
                modal.style.display = 'none';
                if (!document.querySelector(`tr[data-line-id="${lineCount}"]`)) {
                    lineCount--; // 如果取消了则恢复计数器
                }
            }
            
            const chartModal = document.getElementById('chartModal');
            if (event.target === chartModal) {
                chartModal.style.display = 'none';
            }
        });

        // 分析按钮事件
        document.getElementById('runWorkflowButton').addEventListener('click', async () => {
            const personalAccessToken = 'pat_QmQUVWhuPGR5dx3e8hxwuF2VJtrd8Cn3hf0YVGCCJ2xDnyX432UsO4oAMWXsbRtZ';
            const workflowId = '7514613816908103707';
            
            const apiUrl = 'https://api.coze.cn/v1/workflow/run';

            const headers = {
                'Authorization': `Bearer ${personalAccessToken}`,
                'Content-Type': 'application/json'
            };
            
            // 收集表格中所有行数据
            const rows = document.querySelectorAll('#lineTableBody tr');
            const parameters = {};
            
            rows.forEach((row, index) => {
                const lineId = index + 1;
                const name = row.querySelector('td:nth-child(1)').textContent;
                const delay = row.querySelector('.delay-value').textContent;
                const bandwidth = row.querySelector('.bandwidth-value').textContent;
                const lossRate = row.querySelector('.loss-value').textContent;
                const status = row.querySelector('.status-select').value;
                
                // 添加到parameters，key为rode1, rode2, ...
                parameters[`rode${lineId}`] = JSON.stringify({
                    name,
                    delay,
                    bandwidth,
                    lossRate,
                    status
                });
            });
            
            const data = {
                "workflow_id": workflowId,
                "parameters": parameters
            };
            
            // 显示加载提示和弹窗
            document.getElementById('modalResultContent').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div class="loading-text">正在生成中...</div>
                </div>
            `;
            document.getElementById('resultModal').style.display = 'flex';

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                // 将 JSON 转换为 Markdown 格式
                const markdown = convertToMarkdown(result.data);
                // 处理换行符
                const processedMarkdown = processNewlines(markdown);
                // 从第12位开始截取内容
                const truncatedMarkdown = processedMarkdown.substring(12);
                
                // 在弹出窗口中显示结果
                document.getElementById('modalResultContent').innerHTML = truncatedMarkdown;
            } catch (error) {
                console.error('请求出错:', error);
                document.getElementById('modalResultContent').innerHTML = `请求出错: ${error.message}`;
            }
        });
        
        // 关闭弹出窗口的事件处理
        document.getElementById('closeModalButton').addEventListener('click', () => {
            document.getElementById('resultModal').style.display = 'none';
        });
        
        // 关闭图表弹窗
        document.getElementById('closeChartModalButton').addEventListener('click', () => {
            document.getElementById('chartModal').style.display = 'none';
        });
        
        // 为表格行添加点击事件
        document.querySelectorAll('#lineTableBody tr').forEach(row => {
            row.addEventListener('click', handleRowClick);
        });
        
        // 处理表格行点击事件
        function handleRowClick(event) {
            // 如果点击的是下拉菜单，不显示弹窗
            if (event.target.tagName === 'SELECT' || event.target.tagName === 'OPTION') {
                return;
            }
            
            const row = event.currentTarget;
            const lineName = row.querySelector('td:nth-child(1)').textContent;
            const delay = parseFloat(row.querySelector('.delay-value').textContent);
            const bandwidth = parseFloat(row.querySelector('.bandwidth-value').textContent);
            const lossRate = parseFloat(row.querySelector('.loss-value').textContent);
            
            // 更新图表弹窗标题和信息
            document.getElementById('chartModalTitle').textContent = `${lineName} 监控数据`;
            document.getElementById('chartLineName').textContent = lineName;
            document.getElementById('chartLineDelay').textContent = `${delay} ms`;
            document.getElementById('chartLineBandwidth').textContent = `${bandwidth} Mbps`;
            document.getElementById('chartLineLoss').textContent = `${lossRate} %`;
            
            // 生成图表数据并显示
            showCharts(delay, bandwidth, lossRate);
            
            // 显示图表弹窗
            document.getElementById('chartModal').style.display = 'flex';
        }
        
        // 显示所有图表
        function showCharts(baseDelay, baseBandwidth, baseLoss) {
            // 获取当前时间
            const now = new Date();
            
            // 生成实时时间标签
            const timeLabels = [];
            for (let i = 5; i >= 0; i--) {
                const timePoint = new Date(now.getTime() - i * 10 * 60000); // i*10分钟前
                const hours = timePoint.getHours().toString().padStart(2, '0');
                const minutes = timePoint.getMinutes().toString().padStart(2, '0');
                timeLabels.push(`${hours}:${minutes}`);
            }
            
            // 显示延迟图表
            showDelayChart(baseDelay, timeLabels);
            
            // 显示带宽图表
            showBandwidthChart(baseBandwidth, timeLabels);
            
            // 显示丢包率图表
            showLossChart(baseLoss, timeLabels);
        }
        
        // 显示延迟曲线图表
        function showDelayChart(baseDelay, timeLabels) {
            const ctx = document.getElementById('delayChart').getContext('2d');
            
            // 如果已经有图表，先销毁
            if (delayChart) {
                delayChart.destroy();
            }
            
            // 根据基础延迟生成随机波动的延迟数据
            const delayData = generateRandomDelayData(baseDelay, 6);
            
            // 创建图表
            delayChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: '延迟 (ms)',
                        data: delayData,
                        borderColor: '#2288c9',
                        backgroundColor: 'rgba(34, 136, 201, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#2288c9'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: false,
                                text: '延迟 (ms)'
                            },
                            // 根据基础延迟设置适当的最小值和最大值
                            min: Math.max(0, baseDelay - 3),
                            max: baseDelay + 3
                        },
                        x: {
                            grid: {
                                display: true
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `延迟: ${context.raw} ms`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 显示带宽曲线图表
        function showBandwidthChart(baseBandwidth, timeLabels) {
            const ctx = document.getElementById('bandwidthChart').getContext('2d');
            
            // 如果已经有图表，先销毁
            if (bandwidthChart) {
                bandwidthChart.destroy();
            }
            
            // 生成随机波动的带宽数据
            const bandwidthData = generateRandomBandwidthData(baseBandwidth, 6);
            
            // 创建图表
            bandwidthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: '带宽 (Mbps)',
                        data: bandwidthData,
                        borderColor: '#4caf50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#4caf50'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: false,
                                text: '带宽 (Mbps)'
                            },
                            // 根据基础带宽设置适当的最小值和最大值
                            min: Math.max(0, baseBandwidth * 0.9),
                            max: baseBandwidth * 1.1
                        },
                        x: {
                            grid: {
                                display: true
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `带宽: ${context.raw} Mbps`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 显示丢包率曲线图表
        function showLossChart(baseLoss, timeLabels) {
            const ctx = document.getElementById('lossChart').getContext('2d');
            
            // 如果已经有图表，先销毁
            if (lossChart) {
                lossChart.destroy();
            }
            
            // 生成随机波动的丢包率数据
            const lossData = generateRandomLossData(baseLoss, 6);
            
            // 创建图表
            lossChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: '丢包率 (%)',
                        data: lossData,
                        borderColor: '#f44336',
                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#f44336'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: false,
                                text: '丢包率 (%)'
                            },
                            // 根据基础丢包率设置适当的最小值和最大值
                            min: 0,
                            max: Math.max(0.5, baseLoss * 1.5)
                        },
                        x: {
                            grid: {
                                display: true
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `丢包率: ${context.raw} %`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 生成随机波动的延迟数据
        function generateRandomDelayData(baseDelay, count) {
            const data = [];
            for (let i = 0; i < count; i++) {
                // 在基础延迟附近生成随机波动（±2ms）
                const randomVariation = (Math.random() * 4) - 2;
                data.push(Math.max(1, (baseDelay + randomVariation).toFixed(1)));
            }
            return data;
        }
        
        // 生成随机波动的带宽数据
        function generateRandomBandwidthData(baseBandwidth, count) {
            const data = [];
            for (let i = 0; i < count; i++) {
                // 在基础带宽附近生成随机波动（±5%）
                const randomVariation = (Math.random() * 0.1 - 0.05) * baseBandwidth;
                data.push(Math.max(10, Math.round(baseBandwidth + randomVariation)));
            }
            return data;
        }
        
        // 生成随机波动的丢包率数据
        function generateRandomLossData(baseLoss, count) {
            const data = [];
            for (let i = 0; i < count; i++) {
                // 在基础丢包率附近生成随机波动（±0.05%）
                const randomVariation = (Math.random() * 0.1) - 0.05;
                data.push(Math.max(0.01, (baseLoss + randomVariation).toFixed(2)));
            }
            return data;
        }
        
        // 处理换行符的函数
        function processNewlines(text) {
            // 将字符串中的 \n 转换为实际的换行符
            return text.replace(/\\n/g, '<br>');
        }

        // 将 JSON 对象转换为 Markdown 格式的函数
        function convertToMarkdown(obj, level = 0) {
            if (obj === null) return '`null`';
            if (typeof obj !== 'object') return `\`${obj}\``;
            
            const indent = '  '.repeat(level);
            const isArray = Array.isArray(obj);
            const items = isArray ? obj : Object.entries(obj);
            
            if (items.length === 0) return isArray ? '[]' : '{}';
            
            const lines = [];
            if (!isArray) lines.push('| 键 | 值 |');
            if (!isArray) lines.push('| --- | --- |');
            
            items.forEach((item, index) => {
                if (isArray) {
                    const value = typeof item === 'object' ? convertToMarkdown(item, level + 1) : `\`${item}\``;
                    lines.push(`${indent}- ${value}`);
                } else {
                    const [key, value] = item;
                    const formattedValue = typeof value === 'object' ? convertToMarkdown(value, level + 1) : `\`${value}\``;
                    lines.push(`| ${key} | ${formattedValue} |`);
                }
            });
            
            return lines.join('\n');
        }
    </script>
</body>

</html>
